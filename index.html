<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Quiz Capitale ‚Äî Duel synchronis√©</title>
  <style>
    :root{ --bg:#0f172a;--card:#111827;--muted:#94a3b8;--text:#e5e7eb;--accent:#22c55e;--danger:#ef4444;--primary:#3b82f6; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Inter,Arial,sans-serif;background:radial-gradient(1200px 600px at 10% 10%,#1e293b 0,#0b1222 60%,#050915 100%);color:var(--text);min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px}
    .app{width:min(1100px,100%);}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02));border:1px solid rgba(255,255,255,.08);backdrop-filter: blur(6px);border-radius:20px;box-shadow:0 10px 30px rgba(0,0,0,.4);padding:20px}
    h1{font-size:clamp(22px,3.6vw,34px);margin:0 0 14px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    input,select,button{border-radius:12px;border:1px solid rgba(255,255,255,.12);background:#0b1220;color:var(--text);padding:12px 14px;font-size:16px}
    input,select{flex:1;min-width:180px}
    button{cursor:pointer;transition:.2s;background:linear-gradient(180deg,#0f172a,#0b1220)}
    button.primary{border-color:rgba(59,130,246,.5);box-shadow:inset 0 0 0 1px rgba(59,130,246,.35)}
    button.primary:hover{transform:translateY(-1px);background:#0f1a30}
    .grid{display:grid;grid-template-columns:1fr;gap:14px}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08);font-size:14px;color:var(--muted)}
    .muted{color:var(--muted)} .ok{color:var(--accent)} .bad{color:var(--danger)}
    .center{display:flex;align-items:center;justify-content:center}
    .question{font-size:clamp(20px,4vw,28px);font-weight:700;margin:10px 0 6px}
    .country{font-size:clamp(28px,6vw,40px)}
    .answers{display:flex;flex-wrap:wrap;gap:10px;margin-top:8px}
    .answers input{min-width:260px;flex:2}
    .mc-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
    .mc-btn{padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:#0d1424;cursor:pointer}
    .mc-btn:hover{transform:translateY(-1px)}
    .board{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .panel{padding:12px;border-radius:14px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.07)}
    .timer{font-variant-numeric:tabular-nums;font-size:clamp(24px,5vw,42px);font-weight:800}
    .sep{height:1px;background:rgba(255,255,255,.08);margin:8px 0}
    .small{font-size:13px}
    .footer{display:flex;gap:10px;justify-content:space-between;align-items:center;margin-top:8px}
    .hidden{display:none !important}
    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{border-bottom:1px solid rgba(255,255,255,.08);padding:8px 6px;vertical-align:top}
    th{color:#cbd5e1;text-align:left}
    .tag{font-size:12px;color:#cbd5e1}
    .code{font-family:ui-monospace,SFMono-Regular,Menlo,monospace;}
    .good{color:#22c55e;font-weight:600}
    .badx{color:#ef4444}
  </style>
</head>
<body>
<div class="app">
  <div class="card">
    <h1>üåç Quiz Capitale ‚Äî Duel synchronis√©</h1>
    <div id="setup" class="grid">
      <div class="row">
        <input id="playerName" placeholder="Ton pseudo (ex: Thibaud)" />
        <input id="roomId" placeholder="Code salon (ex: RIO974)" />
      </div>
      <div class="row">
        <select id="questionCount">
          <option value="10">10 questions</option>
          <option value="20">20 questions</option>
          <option value="40">40 questions</option>
          <option value="60">60 questions</option>
          <option value="100">100 questions</option>
          <option value="all">Toutes les capitales</option>
        </select>
        <select id="modeSelect" title="Mode de jeu">
          <option value="text">Mode saisie</option>
          <option value="mc">Mode QCM (4 choix)</option>
        </select>
        <button id="createBtn" class="primary">Cr√©er le salon</button>
        <button id="joinBtn">Rejoindre</button>
      </div>
      <p class="small muted">1) Cr√©ez/entrez le <b>code salon</b>. 2) Choisissez le <b>mode</b>. 3) Commencez ‚ñ∂ ‚Äî m√™mes questions et encha√Ænement synchronis√©.</p>
      <div class="sep"></div>
      <div id="lobby" class="hidden">
        <div class="row" style="justify-content:space-between;align-items:center">
          <div>
            <span class="pill">Salon: <span id="lobbyRoom" class="code"></span></span>
            <span class="pill">Questions: <span id="lobbyCount"></span></span>
            <span class="pill">Mode: <span id="lobbyMode"></span></span>
          </div>
          <div><button id="startBtn" class="primary">Commencer ‚ñ∂</button></div>
        </div>
        <div class="board" style="margin-top:10px">
          <div class="panel"><div class="muted small">Joueurs connect√©s</div><ul id="players"></ul></div>
          <div class="panel"><div class="muted small">Partage</div><div class="small">Code √† envoyer : <b id="shareCode" class="code"></b></div></div>
        </div>
      </div>
    </div>

    <div id="game" class="hidden">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div class="pill">Salon <span id="gameRoom" class="code"></span></div>
        <div class="pill">Question <span id="qIndex">1</span>/<span id="qTotal">10</span></div>
        <div class="pill timer" id="timer">30</div>
      </div>
      <div class="center" style="margin:10px 0 6px">
        <div class="question">Quelle est la capitale de</div>
      </div>
      <div class="center"><div class="country" id="country"></div></div>

      <!-- Zone r√©ponses -->
      <div id="textZone" class="answers row center">
        <input id="answer" placeholder="Ta r√©ponse" autocomplete="off" />
        <button id="submitBtn" class="primary">Valider</button>
      </div>
      <div id="mcZone" class="mc-grid hidden">
        <button class="mc-btn" data-i="0"></button>
        <button class="mc-btn" data-i="1"></button>
        <button class="mc-btn" data-i="2"></button>
        <button class="mc-btn" data-i="3"></button>
      </div>

      <div class="footer">
        <div class="small muted">Astuce: accents/majuscules ignor√©s. En QCM, cliquez sur la capitale.</div>
        <div class="small">Score: <b id="myScore">0</b> ‚Äî Adversaire: <b id="opScore">0</b></div>
      </div>
      <div id="roundStatus" class="small muted" style="margin-top:6px"></div>
    </div>

    <div id="results" class="hidden">
      <h2>üèÅ R√©sultats</h2>
      <p class="small muted" id="resSubtitle"></p>
      <div class="board" style="margin-bottom:10px">
        <div class="panel"><div id="meFinal"></div></div>
        <div class="panel"><div id="opFinal"></div></div>
      </div>
      <div class="panel">
        <div class="small muted" style="margin-bottom:8px">D√©tail des questions</div>
        <div style="max-height:50vh;overflow:auto">
          <table id="detailTable">
            <thead>
              <tr>
                <th>#</th><th>Pays</th><th>Capitale</th>
                <th>Toi</th><th>Adversaire</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
      <div class="sep"></div>
      <button onclick="window.location.reload()">Rejouer</button>
    </div>

  </div>
</div>

<!-- Firebase v10 CDN -->
<script type="module">
  // ‚öôÔ∏è Config Firebase ‚Äî garde la tienne
  const firebaseConfig = {
    apiKey: "AIzaSyCe-bTChoBYZzzX_F9Cwf6tZXGIxzS4Qf8",
    authDomain: "quizz-capitales.firebaseapp.com",
    databaseURL: "https://quizz-capitales-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "quizz-capitales",
    storageBucket: "quizz-capitales.appspot.com",
    messagingSenderId: "657917175552",
    appId: "1:657917175552:web:7f35b3595d97919f2835e5"
  };

  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js';
  import { getDatabase, ref, onValue, set, update, get, runTransaction } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js';

  const app = initializeApp(firebaseConfig);
  const db  = getDatabase(app);

  // ======= Utils =======
  const $ = sel => document.querySelector(sel);
  const norm = s => (s||'').toString().normalize('NFD').replace(/\p{Diacritic}/gu,'').replace(/[^a-zA-Z\-\s']/g,'').trim().toLowerCase();
  const rand = (seed => () => (seed = (seed*9301+49297)%233280, seed/233280));
  const seededShuffle = (arr, seed) => { const r = rand(seed); const a = arr.slice(); for(let i=a.length-1;i>0;i--){ const j = Math.floor(r()* (i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; };
  const code = () => ($('#roomId').value||'').replace(/\W/g,'').toUpperCase();
  const uid  = () => localStorage.getItem('uid') || (localStorage.setItem('uid', crypto.randomUUID()), localStorage.getItem('uid'));

  const CAPITALS = [
    ["Afghanistan","Kaboul"],["Albanie","Tirana"],["Alg√©rie","Alger"],["Andorre","Andorre-la-Vieille"],["Angola","Luanda"],
    ["Antigua-et-Barbuda","Saint John's"],["Arabie saoudite","Riyad"],["Argentine","Buenos Aires"],["Arm√©nie","Erevan"],["Australie","Canberra"],
    ["Autriche","Vienne"],["Azerba√Ødjan","Bakou"],["Bahamas","Nassau"],["Bahre√Øn","Manama"],["Bangladesh","Dacca"],
    ["Barbade","Bridgetown"],["Belgique","Bruxelles"],["Belize","Belmopan"],["B√©nin","Porto-Novo"],["Bhoutan","Thimphou"],
    ["Bi√©lorussie","Minsk"],["Birmanie (Myanmar)","Naypyidaw"],["Bolivie","Sucre"],["Bosnie-Herz√©govine","Sarajevo"],["Botswana","Gaborone"],
    ["Br√©sil","Bras√≠lia"],["Brunei","Bandar Seri Begawan"],["Bulgarie","Sofia"],["Burkina Faso","Ouagadougou"],["Burundi","Gitega"],
    ["Cambodge","Phnom Penh"],["Cameroun","Yaound√©"],["Canada","Ottawa"],["Cap-Vert","Praia"],["Centrafrique","Bangui"],
    ["Chili","Santiago"],["Chine","P√©kin"],["Chypre","Nicosie"],["Colombie","Bogot√°"],["Comores","Moroni"],
    ["Congo (RDC)","Kinshasa"],["Congo (R√©publique)","Brazzaville"],["Cor√©e du Nord","Pyongyang"],["Cor√©e du Sud","S√©oul"],["Costa Rica","San Jos√©"],
    ["C√¥te d‚ÄôIvoire","Yamoussoukro"],["Croatie","Zagreb"],["Cuba","La Havane"],["Danemark","Copenhague"],["Djibouti","Djibouti"],
    ["Dominique","Roseau"],["√âgypte","Le Caire"],["√âmirats arabes unis","Abou Dabi"],["√âquateur","Quito"],["√ârythr√©e","Asmara"],
    ["Espagne","Madrid"],["Estonie","Tallinn"],["Eswatini","Mbabane"],["√âtats-Unis","Washington"],["√âthiopie","Addis-Abeba"],
    ["Fidji","Suva"],["Finlande","Helsinki"],["France","Paris"],["Gabon","Libreville"],["Gambie","Banjul"],
    ["G√©orgie","Tbilissi"],["Ghana","Accra"],["Gr√®ce","Ath√®nes"],["Grenade","Saint George's"],["Guatemala","Guatemala"],
    ["Guin√©e","Conakry"],["Guin√©e-Bissau","Bissau"],["Guin√©e √©quatoriale","Malabo"],["Guyana","Georgetown"],["Ha√Øti","Port-au-Prince"],
    ["Honduras","Tegucigalpa"],["Hongrie","Budapest"],["√éles Marshall","Delap-Uliga-Darrit"],["Inde","New Delhi"],["Indon√©sie","Jakarta"],
    ["Irak","Bagdad"],["Iran","T√©h√©ran"],["Irlande","Dublin"],["Islande","Reykjavik"],["Isra√´l","J√©rusalem"],
    ["Italie","Rome"],["Jama√Øque","Kingston"],["Japon","Tokyo"],["Jordanie","Amman"],["Kazakhstan","Astana"],
    ["Kenya","Nairobi"],["Kirghizistan","Bichkek"],["Kiribati","Tarawa-Sud"],["Kosovo","Pristina"],["Kowe√Øt","Kowe√Øt"],
    ["Laos","Vientiane"],["Lesotho","Maseru"],["Lettonie","Riga"],["Liban","Beyrouth"],["Lib√©ria","Monrovia"],
    ["Libye","Tripoli"],["Liechtenstein","Vaduz"],["Lituanie","Vilnius"],["Luxembourg","Luxembourg"],["Mac√©doine du Nord","Skopje"],
    ["Madagascar","Antananarivo"],["Malaisie","Kuala Lumpur"],["Malawi","Lilongwe"],["Maldives","Mal√©"],["Mali","Bamako"],
    ["Malte","La Valette"],["Maroc","Rabat"],["Maurice","Port-Louis"],["Mauritanie","Nouakchott"],["Mexique","Mexico"],
    ["Micron√©sie","Palikir"],["Moldavie","Chisinau"],["Monaco","Monaco"],["Mongolie","Oulan-Bator"],["Mont√©n√©gro","Podgorica"],
    ["Mozambique","Maputo"],["Namibie","Windhoek"],["Nauroo","Yaren"],["N√©pal","Katmandou"],["Nicaragua","Managua"],
    ["Niger","Niamey"],["Nigeria","Abuja"],["Norv√®ge","Oslo"],["Nouvelle-Z√©lande","Wellington"],["Oman","Mascate"],
    ["Ouganda","Kampala"],["Ouzb√©kistan","Tachkent"],["Pakistan","Islamabad"],["Palaos","Ngerulmud"],["Panama","Panama"],
    ["Papouasie-Nouvelle-Guin√©e","Port Moresby"],["Paraguay","Asuncion"],["Pays-Bas","Amsterdam"],["P√©rou","Lima"],["Philippines","Manille"],
    ["Pologne","Varsovie"],["Portugal","Lisbonne"],["Qatar","Doha"],["R√©publique tch√®que","Prague"],["Roumanie","Bucarest"],
    ["Royaume-Uni","Londres"],["Russie","Moscou"],["Rwanda","Kigali"],["Saint-Christophe-et-Ni√©v√®s","Basseterre"],["Sainte-Lucie","Castries"],
    ["Saint-Vincent-et-les-Grenadines","Kingstown"],["Salomon (√éles)","Honiara"],["Salvador","San Salvador"],["Samoa","Apia"],["Sao Tom√©-et-Principe","S√£o Tom√©"],
    ["S√©n√©gal","Dakar"],["Serbie","Belgrade"],["Seychelles","Victoria"],["Sierra Leone","Freetown"],["Singapour","Singapour"],
    ["Slovaquie","Bratislava"],["Slov√©nie","Ljubljana"],["Somalie","Mogadiscio"],["Soudan","Khartoum"],["Soudan du Sud","Djouba"],
    ["Sri Lanka","Sri Jayawardenepura Kotte"],["Su√®de","Stockholm"],["Suisse","Berne"],["Suriname","Paramaribo"],["Syrie","Damas"],
    ["Tadjikistan","Douchanb√©"],["Tanzanie","Dodoma"],["Tchad","N'Djamena"],["Tha√Ølande","Bangkok"],["Timor oriental","Dili"],
    ["Togo","Lom√©"],["Tonga","Nuku'alofa"],["Trinit√©-et-Tobago","Port d'Espagne"],["Tunisie","Tunis"],["Turkm√©nistan","Achgabat"],
    ["Turquie","Ankara"],["Tuvalu","Funafuti"],["Ukraine","Kiev"],["Uruguay","Montevideo"],["Vanuatu","Port-Vila"],
    ["Vatican","Vatican"],["Venezuela","Caracas"],["Vi√™t Nam","Hano√Ø"],["Y√©men","Sanaa"],["Zambie","Lusaka"],["Zimbabwe","Harare"]
  ];

  const ALIASES = new Map([
    ["saint johns","saint john's"],["st johns","saint john's"],["washington dc","washington"],["la havane","la havane"],
    ["sao tome","s√£o tom√©"],["sao tom√©","s√£o tom√©"],["sao tome et principe","s√£o tom√©"],["bichkek","bichkek"],
    ["oulan bator","oulan-bator"],["douchambe","douchanb√©"],["dacca","dacca"],["rangoun","naypyidaw"],["al quds","j√©rusalem"],
    ["pekin","p√©kin"],["kiev","kiev"],["kyiv","kiev"],["sanaa","sanaa"],["nuku alofa","nuku'alofa"],["porto novo","porto-novo"],
    ["st george","saint george's"],["st georges","saint george's"],["port of spain","port d'espagne"],["delhi","new delhi"],
    ["riyadh","riyad"],["ulaanbaatar","oulan-bator"],["kotte","sri jayawardenepura kotte"],
    ["prague","prague"],["warsaw","varsovie"],["vienna","vienne"],["athens","ath√®nes"],["rome","rome"],["london","londres"]
  ]);

  // ======= Local state =======
  let ROOM = null;
  let ME = { id: uid(), name: '' };
  let TIMER = null;
  let ROOM_MODE = 'text'; // 'text' | 'mc'

  // ---- Helpers for MC options (m√™mes pour tous via graine) ----
  function mcOptions(orderIndex, seedBase){
    const idx = orderIndex;
    const pair = CAPITALS[idx];
    const correct = pair[1];
    const allCaps = CAPITALS.map(p=>p[1]);
    const others = allCaps.filter(c => c !== correct);
    const distract = seededShuffle(others, seedBase*1000 + idx).slice(0,3);
    const opts = [correct, ...distract];
    return seededShuffle(opts, seedBase*5000 + idx); // m√©lange final
  }

  // ======= UI events =======
  $('#createBtn').onclick = async () => {
    ME.name = ($('#playerName').value||'').trim() || 'Joueur-'+uid().slice(0,4);
    const id = code(); if(!id){ alert('Choisis un code salon (ex: RIO974).'); return; }
    const mode = $('#modeSelect').value; ROOM_MODE = mode;
    const countSel = $('#questionCount').value;
    const count = countSel==='all' ? CAPITALS.length : parseInt(countSel,10);
    const seed = Math.abs([...id].reduce((a,c)=>a*33+c.charCodeAt(0),7))%1000000;
    const order = seededShuffle([...Array(CAPITALS.length).keys()], seed).slice(0,count);

    ROOM = id;
    const roomRef = ref(db, 'rooms/'+ROOM);
    await set(roomRef, {
      createdAt: Date.now(),
      seed, count, order, mode,
      started: false, index: 0,
      players: { [ME.id]: { name: ME.name, score: 0, answered: false, last:"", history: [] } },
    });
    enterLobby(count, mode);
  };

  $('#joinBtn').onclick = async () => {
    ME.name = ($('#playerName').value||'').trim() || 'Joueur-'+uid().slice(0,4);
    const id = code(); if(!id){ alert('Entre le code salon.'); return; }
    ROOM = id;
    const roomRef = ref(db, 'rooms/'+ROOM);
    const snap = await get(roomRef);
    if(!snap.exists()) { alert('Salon introuvable. Demande au pote de le cr√©er.'); return; }
    const data = snap.val();
    ROOM_MODE = data.mode || 'text';
    await update(roomRef, { ['players/'+ME.id]: { name: ME.name, score: 0, answered: false, last:"", history: [] } });
    enterLobby(data.count, ROOM_MODE);
  };

  function enterLobby(count, mode){
    $('#setup').classList.remove('grid');
    $('#lobby').classList.remove('hidden');
    $('#lobbyRoom').textContent = ROOM;
    $('#shareCode').textContent = ROOM;
    $('#lobbyCount').textContent = count;
    $('#lobbyMode').textContent = mode==='mc' ? 'QCM' : 'Saisie';
    $('#startBtn').style.display = 'inline-block';
    onValue(ref(db, 'rooms/'+ROOM+'/players'), (s)=>{
      const v=s.val()||{}; $('#players').innerHTML = Object.values(v).map(p=>`<li>${p.name} ‚Äî <span class="muted small">${p.score} pts</span></li>`).join('');
    });
    onValue(ref(db, 'rooms/'+ROOM+'/started'), (s)=>{ if(s.val()) startGame(); });
    $('#startBtn').onclick = async ()=>{ await update(ref(db, 'rooms/'+ROOM), { started:true, index:0 }); };
  }

  function startGame(){
    $('#setup').classList.add('hidden');
    $('#game').classList.remove('hidden');
    $('#gameRoom').textContent = ROOM; $('#roundStatus').textContent='';

    // Affiche bon mode
    onValue(ref(db, 'rooms/'+ROOM+'/mode'), (s)=> {
      ROOM_MODE = s.val() || 'text';
      if(ROOM_MODE==='mc'){ $('#textZone').classList.add('hidden'); $('#mcZone').classList.remove('hidden'); }
      else { $('#mcZone').classList.add('hidden'); $('#textZone').classList.remove('hidden'); }
    });

    // √âtat de la partie
    onValue(ref(db, 'rooms/'+ROOM), s=>{
      const r = s.val(); if(!r) return;
      const idx = r.index;
      $('#qTotal').textContent = r.count;
      $('#qIndex').textContent = Math.min(idx+1, r.count);
      const pair = CAPITALS[r.order[idx]] || [];
      $('#country').textContent = pair[0] || '';
      const others = Object.entries(r.players||{}).filter(([id])=>id!==ME.id).map(([,p])=>p);
      $('#opScore').textContent = others[0]?.score ?? 0;
      $('#myScore').textContent = r.players?.[ME.id]?.score ?? 0;

      // Remplir QCM si besoin
      if(ROOM_MODE==='mc' && r.order[idx]!==undefined){
        const opts = mcOptions(r.order[idx], r.seed);
        document.querySelectorAll('.mc-btn').forEach((b,i)=>{ b.textContent = opts[i] || ''; b.disabled = false; });
      }

      if(idx>=r.count){ showResults(r); }
    });

    startTimer(30);
    onValue(ref(db, 'rooms/'+ROOM+'/index'), ()=>{ resetForNext(); startTimer(30); });

    // Handlers
    $('#submitBtn').onclick = submitAnswer;
    $('#answer').addEventListener('keydown',e=>{ if(e.key==='Enter') submitAnswer(); });
    document.querySelectorAll('.mc-btn').forEach(btn=>{
      btn.onclick = ()=>{ submitAnswer(btn.textContent); btn.disabled = true; };
    });
  }

  function startTimer(s){ clearInterval(TIMER); let t=s; $('#timer').textContent=t; TIMER=setInterval(()=>{ t--; $('#timer').textContent=t; if(t<=0){ clearInterval(TIMER); autoLock(); } },1000); }
  function resetForNext(){ $('#answer').value=''; $('#roundStatus').textContent=''; clearInterval(TIMER); }

  async function submitAnswer(valueFromMC){
    const ans = (valueFromMC!==undefined) ? valueFromMC : $('#answer').value.trim();
    if(!ans && ROOM_MODE==='text') return autoLock();
    await lockAndEvaluate(ans||'');
  }
  async function autoLock(){ await lockAndEvaluate(''); }

  async function lockAndEvaluate(raw){
    const base = ref(db, 'rooms/'+ROOM);
    await runTransaction(base, (room)=>{
      if(!room || room.index>=room.count) return room;
      const idx = room.index;
      const qIdx = room.order[idx];
      const [country, cap] = CAPITALS[qIdx];
      const me = room.players?.[ME.id] || { name: ME.name, score:0, answered:false, last:"", history: [] };
      if(me.answered) return room; // d√©j√† r√©pondu

      const expected = norm(cap);
      const gotNorm = norm(ALIASES.get(norm(raw)) || raw);
      const ok = gotNorm && expected===norm(ALIASES.get(gotNorm)||gotNorm);

      me.answered = true; me.last = raw;
      if(ok) me.score = (me.score||0) + 1;

      // Historique d√©taill√©
      me.history = me.history || [];
      me.history.push({ idx:qIdx, country, correct:cap, answer: raw, ok });

      room.players[ME.id] = me;

      // Passage √† la suite quand tout le monde a r√©pondu
      const allAnswered = Object.values(room.players).every(p=>p.answered);
      if(allAnswered){
        for(const pid of Object.keys(room.players)) room.players[pid].answered=false;
        room.index = idx+1;
      }
      return room;
    });
  }

  function showResults(room){
    $('#game').classList.add('hidden');
    $('#results').classList.remove('hidden');

    const me = room.players?.[ME.id];
    const others = Object.entries(room.players||{}).filter(([id])=>id!==ME.id).map(([,p])=>p);
    const op = others[0]||{name:'Adversaire',score:0,history:[]};
    $('#resSubtitle').textContent = `Mode: ${room.mode==='mc'?'QCM':'Saisie'} ‚Ä¢ Total: ${room.count} questions`;

    $('#meFinal').innerHTML = `<div class="big">${me?.name||'Moi'}</div><div class="ok" style="font-size:36px;font-weight:800">${me?.score||0} pts</div>`;
    $('#opFinal').innerHTML = `<div class="big">${op.name}</div><div class="ok" style="font-size:36px;font-weight:800">${op.score} pts</div>`;

    // Fusionne l'historique par ordre des questions
    const myH = me?.history||[];
    const opH = op?.history||[];
    const byIdx = new Map();
    for(const h of myH) byIdx.set(h.idx, {country:h.country, correct:h.correct, me:h});
    for(const h of opH){
      const cur = byIdx.get(h.idx) || {country:h.country, correct:h.correct, me:null};
      cur.op = h;
      byIdx.set(h.idx, cur);
    }
    // ordonner comme room.order
    const tbody = $('#detailTable tbody'); tbody.innerHTML='';
    room.order.forEach((qIdx, i)=>{
      const rec = byIdx.get(qIdx) || {country: CAPITALS[qIdx][0], correct: CAPITALS[qIdx][1], me:null, op:null};
      const meTxt = rec.me ? `${rec.me.answer||'‚àÖ'} ${rec.me.ok?'<span class="good">‚úÖ</span>':'<span class="badx">‚ùå</span>'}` : '‚Äî';
      const opTxt = rec.op ? `${rec.op.answer||'‚àÖ'} ${rec.op.ok?'<span class="good">‚úÖ</span>':'<span class="badx">‚ùå</span>'}` : '‚Äî';
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${i+1}</td><td>${rec.country}</td><td>${rec.correct}</td><td>${meTxt}</td><td>${opTxt}</td>`;
      tbody.appendChild(tr);
    });
  }

  // UX
  $('#playerName').value = localStorage.getItem('lastName')||'';
  $('#playerName').addEventListener('change',()=>localStorage.setItem('lastName',$('#playerName').value));
</script>
</body>
</html>
